# Content Engine Integration

This document explains how the Content Engine integrates with the existing Renderer pipeline.

## Overview

The Content Engine now outputs files directly to the same directories that the Renderer expects, enabling seamless integration between LLM-generated content and the existing build pipeline.

## File Structure

After Content Engine execution:

```
AI_content_gen/
├── CR_chapters/          # DocJSON files (Content Engine M4 output)
│   ├── gravitation.json  # Existing manual content
│   └── {generated}.json  # Generated by Content Engine
├── plots/                # PlotSpec files
│   ├── uniform-accel.json     # Existing specs
│   └── {generated-id}.json    # Generated by Content Engine
├── diagrams/             # DiagramSpec files
│   ├── vec-projection.json    # Existing specs
│   └── {generated-id}.json    # Generated by Content Engine
├── CR_rendered/          # Build output (from chapter:build)
│   └── chapter.json      # Pre-rendered for Reader
└── content-engine/
    └── cache/            # SVG compilation cache
```

## Workflow Options

### Option 1: Content Engine → Renderer (New)

```bash
# Generate chapter using Content Engine
npm run content:generate

# Build for renderer (existing script)
npm run chapter:build

# Start development server
npm run dev
```

### Option 2: Combined Workflow (New)

```bash
# Generate + build + serve in one command
npm run dev:full
```

### Option 3: Manual Content (Existing)

```bash
# Build existing manual content
npm run chapter:build:gravitation

# Start development server
npm run dev
```

## Content Engine Commands

### Generate Chapter

```bash
# Basic generation
npm run content:generate

# With custom title and subject
npm run content:generate -- --title "Laws of Motion" --subject Physics

# Help
tsx scripts/generate-chapter.ts --help
```

### Output Locations

- **Chapter DocJSON**: `CR_chapters/{chapter-id}.json`
- **Plot specs**: `plots/{asset-id}.json`
- **Diagram specs**: `diagrams/{asset-id}.json`
- **SVG cache**: `content-engine/cache/{plots|diagrams|chem}/{hash}.svg`

## Integration Details

### M4 Assembler Changes

1. **Output Path**: Changed from `./artifacts` to `../..` (repo root)
2. **Chapter Directory**: Writes to `CR_chapters/` instead of `artifacts/chapters/`
3. **Asset Paths**: Generates flat structure (`plots/{id}.json`) not nested

### M3 Section Generator Changes

1. **Spec Path Generation**: Added `generateSpecPath()` method
2. **Renderer Compatibility**: Paths match existing `plots/`, `diagrams/` structure
3. **Asset References**: Uses deterministic asset IDs for cross-references

### Pipeline Integration

- Content Engine M4 output → `CR_chapters/`, `plots/`, `diagrams/`
- Renderer `chapter:build` script reads from these directories (unchanged)
- Vite serves from `CR_rendered/` (unchanged)

## Compatibility

✅ **Preserves existing renderer infrastructure**
✅ **No changes to Reader React app**
✅ **Can mix manual and generated content**
✅ **Existing build scripts work unchanged**

## Troubleshooting

### Content Engine Fails
- Check `.env` configuration for OpenAI API keys
- Ensure Python RDKit service is running: `uvicorn python.rdkit_service.main:app --host 127.0.0.1 --port 8000`
- Check tectonic.exe and dvisvgm.exe are available

### Renderer Build Fails
- Verify DocJSON passes schema validation
- Check that referenced plot/diagram specs exist
- Ensure SMILES strings are valid for chemistry assets

### Reader Display Issues
- Confirm `CR_rendered/chapter.json` was created successfully
- Check browser console for fetch errors
- Verify Vite is serving from correct publicDir (`CR_rendered`)

## File Format Compatibility

The Content Engine generates Reader-compatible DocJSON that passes all validation gates:

- **G10**: Reader schema validation (CRITICAL)
- **G8**: Cross-reference validation
- **G1-G7**: Content validation (KaTeX, math, plots, etc.)

Asset specs match existing formats:
- PlotSpec: Compatible with `compilePlotToSVG()`
- DiagramSpec: Compatible with `compileDiagramToSVG()`
- ChemSpec: Compatible with `smilesToSVG()`